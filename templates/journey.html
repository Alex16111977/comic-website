<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ character.title }} | K√∂nig Lear</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* –ë–ê–ó–û–í–´–ï –°–¢–ò–õ–ò */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.95);
            min-height: 100vh;
        }

        /* HEADER */
        .page-header {
            text-align: center;
            margin-bottom: 3rem;
            padding: 2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 1rem;
        }

        .header-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .home-link {
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: opacity 0.3s;
        }

        .home-link:hover {
            opacity: 0.8;
        }

        /* JOURNEY TIMELINE */
        .journey-timeline {
            position: relative;
            margin: 2rem 0;
        }

        .journey-points {
            display: flex;
            justify-content: space-between;
            position: relative;
            z-index: 2;
        }

        .journey-point {
            flex: 1;
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s;
            padding: 0.5rem;
        }

        .journey-point:hover {
            transform: translateY(-5px);
        }

        .journey-point.active .point-circle {
            background: #667eea;
            color: white;
            transform: scale(1.2);
        }

        .point-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: white;
            border: 3px solid #667eea;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 0.5rem;
            font-size: 1.5rem;
            transition: all 0.3s;
        }

        /* VOCABULARY SECTION */
        .vocabulary-section {
            margin: 3rem 0;
            padding: 2rem;
            background: #f8f9fa;
            border-radius: 1rem;
        }

        .vocabulary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .vocab-card {
            background: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .vocab-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        /* EXERCISES */
        .exercises-section {
            margin: 3rem 0;
        }

        .exercises-accordion {
            background: white;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .exercise-panel {
            border-bottom: 1px solid #e2e8f0;
        }

        .exercise-toggle {
            width: 100%;
            padding: 1.5rem;
            background: white;
            border: none;
            text-align: left;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: background 0.3s;
        }

        .exercise-toggle:hover {
            background: #f8f9fa;
        }

        .exercise-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            padding: 0 1.5rem;
        }

        .exercise-content.expanded {
            max-height: 2000px;
            padding: 1.5rem;
        }

        /* –£–ü–†–ê–ñ–ù–ï–ù–ò–Ø - –ê–†–¢–ò–ö–õ–ò */
        .articles-exercise {
            padding: 1rem;
        }

        .article-columns {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .article-column {
            background: #f8f9fa;
            border-radius: 0.5rem;
            padding: 1rem;
        }

        .article-drop-zone {
            min-height: 150px;
            background: white;
            border: 2px dashed #cbd5e0;
            border-radius: 0.5rem;
            padding: 0.5rem;
            margin-top: 1rem;
        }

        .article-drop-zone.drag-over {
            background: #e6f3ff;
            border-color: #667eea;
        }

        .article-word-card {
            background: white;
            border: 2px solid #cbd5e0;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin: 0.5rem;
            cursor: move;
            transition: all 0.3s;
        }

        .article-word-card.dragging {
            opacity: 0.5;
        }

        .article-word-card.correct {
            background: #d4edda;
            border-color: #28a745;
        }

        .article-word-card.incorrect {
            background: #f8d7da;
            border-color: #dc3545;
        }

        .article-word-card.selected {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        /* –ö–û–ù–¢–ï–ö–°–¢–ù–´–ï –£–ü–†–ê–ñ–ù–ï–ù–ò–Ø */
        .context-exercise-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin: 1rem 0;
        }

        .context-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin: 1rem 0;
        }

        .context-option {
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 0.5rem;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .context-option:hover:not(:disabled) {
            background: #f8f9fa;
            border-color: #667eea;
        }

        .context-option.correct {
            background: #d4edda;
            border-color: #28a745;
        }

        .context-option.incorrect {
            background: #f8d7da;
            border-color: #dc3545;
        }

        /* FEEDBACK */
        .articles-feedback,
        .context-feedback {
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            text-align: center;
            font-weight: 600;
        }

        .articles-feedback.success,
        .context-feedback.success {
            background: #d4edda;
            color: #155724;
        }

        .articles-feedback.partial,
        .context-feedback.error {
            background: #fff3cd;
            color: #856404;
        }

        /* BUTTONS */
        button {
            cursor: pointer;
            font-family: inherit;
        }

        .check-articles-btn,
        .reset-articles-btn {
            padding: 0.75rem 1.5rem;
            margin: 0.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.3s;
        }

        .check-articles-btn {
            background: #667eea;
            color: white;
        }

        .check-articles-btn:hover {
            background: #5a67d8;
        }

        .reset-articles-btn {
            background: #e2e8f0;
            color: #333;
        }

        .reset-articles-btn:hover {
            background: #cbd5e0;
        }

        /* BOTTOM NAV */
        .bottom-nav {
            margin-top: 3rem;
            padding: 2rem;
            text-align: center;
            border-top: 2px solid #e2e8f0;
        }

        .nav-link {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s;
        }

        .nav-link:hover {
            color: #5a67d8;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="page-header">
            <div class="header-nav">
                <a href="{{ navigation.home_href }}" class="home-link">
                    <span class="arrow">{{ navigation.home_icon }}</span>
                    <span class="text">{{ navigation.home_label }}</span>
                </a>
                <div class="study-counter">
                    <span>{{ navigation.study_label }}</span>
                    <span class="counter-badge" data-study-count>0</span>
                </div>
            </div>
            <h1>üëë {{ character.title }}</h1>
            <p class="subtitle">–ò–∑—É—á–∞–µ–º –Ω–µ–º–µ—Ü–∫–∏–π —á–µ—Ä–µ–∑ —Ç—Ä–∞–≥–µ–¥–∏—é –®–µ–∫—Å–ø–∏—Ä–∞</p>
        </header>

        <div class="journey-section">
            <h2>üìö –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ {{ character.name }}</h2>

            <div class="journey-timeline">
                <div class="journey-points">
                    {% for phase in journey_phases %}
                    <div class="journey-point{% if loop.first %} active{% endif %}" data-phase="{{ phase.id }}">
                        <div class="point-circle">{{ phase.icon }}</div>
                        <h4>{{ phase.title }}</h4>
                        {% if phase.keywords %}
                        <p>{{ phase.keywords }}</p>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="vocabulary-section">
            <h2>üìñ –°–ª–æ–≤–∞—Ä—å: –§–∞–∑–∞ "<span id="current-phase">{{ first_phase_title }}</span>"</h2>
            <div class="vocabulary-grid"></div>
        </div>

        <div class="exercises-section">
            <h2>üìù –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</h2>

            <div class="exercises-accordion">
                <div class="exercise-panel" data-exercise="articles">
                    <button class="exercise-toggle" type="button">
                        <span class="toggle-icon">‚ñ∂</span>
                        üéØ –ê—Ä—Ç–∏–∫–ª–∏ –∏ —Ä–æ–¥
                    </button>
                    <div class="exercise-content">
                        <div class="exercise-phase-wrapper">
                            {% for phase in journey_phases %}
                            <section class="exercise-phase{% if loop.first %} active{% endif %}" data-phase="{{ phase.id }}">
                                <div class="articles-container" data-articles-container data-phase="{{ phase.id }}"></div>
                            </section>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div class="exercise-panel" data-exercise="context">
                    <button class="exercise-toggle" type="button">
                        <span class="toggle-icon">‚ñ∂</span>
                        üìö –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥
                    </button>
                    <div class="exercise-content">
                        <div class="exercise-phase-wrapper">
                            {% for phase in journey_phases %}
                            <section class="exercise-phase{% if loop.first %} active{% endif %}" data-phase="{{ phase.id }}">
                                <div class="context-container" data-context-container data-phase="{{ phase.id }}"></div>
                            </section>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <nav class="bottom-nav">
            <a href="{{ navigation.home_href }}" class="nav-link">‚Üê –ö –≥–ª–∞–≤–Ω–æ–π</a>
        </nav>
    </div>

    <script>
    // ========================================
    // –ï–î–ò–ù–´–ô RUNTIME –ë–ï–ó –†–ï–ö–£–†–°–ò–ò
    // ========================================
    (function() {
        'use strict';

        // –î–∞–Ω–Ω—ã–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –∏ —Ñ–∞–∑ (–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è Python)
        {{ journey_data | safe }}

        // ========================================
        // –ë–ê–ó–û–í–ê–Ø –ù–ê–í–ò–ì–ê–¶–ò–Ø –ü–û –§–ê–ó–ê–ú
        // ========================================
        let currentPhaseIndex = 0;
        const phaseKeys = Object.keys(window.phaseVocabularies || {});
        
        function changePhase(index) {
            if (index < 0 || index >= phaseKeys.length) return;
            
            currentPhaseIndex = index;
            const phaseId = phaseKeys[index];
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Ç–æ—á–∫–∏ –Ω–∞ timeline
            document.querySelectorAll('.journey-point').forEach((point, i) => {
                point.classList.toggle('active', i === index);
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–∫—É—â–µ–π —Ñ–∞–∑—ã
            const currentPhaseSpan = document.getElementById('current-phase');
            if (currentPhaseSpan && window.phaseVocabularies[phaseId]) {
                currentPhaseSpan.textContent = window.phaseVocabularies[phaseId].title;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ª–æ–≤–∞—Ä—å
            updateVocabulary(phaseId);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
            updateExercises(phaseId);
        }

        // ========================================
        // –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–õ–û–í–ê–†–Ø
        // ========================================
        function updateVocabulary(phaseId) {
            const grid = document.querySelector('.vocabulary-grid');
            if (!grid) return;
            
            const phaseData = window.phaseVocabularies[phaseId];
            if (!phaseData || !phaseData.words) {
                grid.innerHTML = '<p>–ù–µ—Ç —Å–ª–æ–≤ –¥–ª—è —ç—Ç–æ–π —Ñ–∞–∑—ã</p>';
                return;
            }
            
            grid.innerHTML = phaseData.words.map(word => `
                <div class="vocab-card">
                    <div style="font-size: 1.2rem; font-weight: bold; color: #667eea;">
                        ${word.word}
                    </div>
                    <div style="margin: 0.5rem 0; color: #666;">
                        ${word.translation}
                    </div>
                    ${word.transcription ? `
                        <div style="font-size: 0.9rem; color: #999; font-style: italic;">
                            [${word.transcription}]
                        </div>
                    ` : ''}
                    ${word.sentence ? `
                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e2e8f0;">
                            <div style="color: #333;">${word.sentence}</div>
                            <div style="color: #666; font-size: 0.9rem; margin-top: 0.25rem;">
                                ${word.sentenceTranslation}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        // ========================================
        // –û–ë–ù–û–í–õ–ï–ù–ò–ï –£–ü–†–ê–ñ–ù–ï–ù–ò–ô
        // ========================================
        function updateExercises(phaseId) {
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Ñ–∞–∑—ã —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π
            document.querySelectorAll('.exercise-phase').forEach(phase => {
                phase.classList.remove('active');
                phase.style.display = 'none';
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â—É—é —Ñ–∞–∑—É
            document.querySelectorAll(`.exercise-phase[data-phase="${phaseId}"]`).forEach(phase => {
                phase.classList.add('active');
                phase.style.display = 'block';
            });
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –¥–ª—è —Ç–µ–∫—É—â–µ–π —Ñ–∞–∑—ã
            initializeExercisesForPhase(phaseId);
        }

        // ========================================
        // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –£–ü–†–ê–ñ–ù–ï–ù–ò–ô (–ë–ï–ó –†–ï–ö–£–†–°–ò–ò)
        // ========================================
        function initializeExercisesForPhase(phaseId) {
            const phaseData = window.phaseVocabularies[phaseId];
            if (!phaseData) return;
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è —Å –∞—Ä—Ç–∏–∫–ª—è–º–∏
            const articlesContainer = document.querySelector(`[data-articles-container][data-phase="${phaseId}"]`);
            if (articlesContainer && !articlesContainer.dataset.initialized) {
                initializeArticlesExercise(articlesContainer, phaseData);
                articlesContainer.dataset.initialized = 'true';
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –ø–µ—Ä–µ–≤–æ–¥–∞
            const contextContainer = document.querySelector(`[data-context-container][data-phase="${phaseId}"]`);
            if (contextContainer && !contextContainer.dataset.initialized) {
                initializeContextTranslation(contextContainer, phaseData);
                contextContainer.dataset.initialized = 'true';
            }
        }

        // ========================================
        // –£–ü–†–ê–ñ–ù–ï–ù–ò–ï: –ê–†–¢–ò–ö–õ–ò –ò –†–û–î
        // ========================================
        function initializeArticlesExercise(container, phaseData) {
            const wordsWithArticles = [];
            
            if (phaseData.words) {
                phaseData.words.forEach(word => {
                    const parts = word.word.split(' ');
                    if (['der', 'die', 'das'].includes(parts[0]?.toLowerCase())) {
                        wordsWithArticles.push({
                            article: parts[0].toLowerCase(),
                            german: parts.slice(1).join(' '),
                            russian: word.translation,
                            fullWord: word.word
                        });
                    }
                });
            }
            
            if (wordsWithArticles.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">–í —ç—Ç–æ–π —Ñ–∞–∑–µ –Ω–µ—Ç —Å–ª–æ–≤ —Å –∞—Ä—Ç–∏–∫–ª—è–º–∏</p>';
                return;
            }
            
            // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º –∏ –±–µ—Ä–µ–º –¥–æ 9 —Å–ª–æ–≤
            const shuffled = wordsWithArticles
                .sort(() => Math.random() - 0.5)
                .slice(0, 9);
            
            container.innerHTML = `
                <div class="articles-exercise">
                    <p style="margin-bottom: 1rem;">–†–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç–µ —Å–ª–æ–≤–∞ –ø–æ —Ä–æ–¥–∞–º:</p>
                    
                    <div class="article-columns">
                        <div class="article-column">
                            <h5 style="text-align: center; color: #667eea;">DER (–º—É–∂—Å–∫–æ–π)</h5>
                            <div class="article-drop-zone" data-zone="der"></div>
                        </div>
                        <div class="article-column">
                            <h5 style="text-align: center; color: #667eea;">DIE (–∂–µ–Ω—Å–∫–∏–π)</h5>
                            <div class="article-drop-zone" data-zone="die"></div>
                        </div>
                        <div class="article-column">
                            <h5 style="text-align: center; color: #667eea;">DAS (—Å—Ä–µ–¥–Ω–∏–π)</h5>
                            <div class="article-drop-zone" data-zone="das"></div>
                        </div>
                    </div>
                    
                    <div class="words-to-sort" style="margin: 1.5rem 0; padding: 1rem; background: #f8f9fa; border-radius: 0.5rem;">
                        ${shuffled.map(word => `
                            <div class="article-word-card" 
                                 data-article="${word.article}"
                                 draggable="true">
                                <strong>${word.german}</strong><br>
                                <small>${word.russian}</small>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="text-align: center;">
                        <button class="check-articles-btn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
                        <button class="reset-articles-btn">–°–±—Ä–æ—Å–∏—Ç—å</button>
                    </div>
                    <div class="articles-feedback"></div>
                </div>
            `;
            
            attachArticlesHandlers(container);
        }

        // ========================================
        // –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –î–õ–Ø –ê–†–¢–ò–ö–õ–ï–ô
        // ========================================
        function attachArticlesHandlers(container) {
            const cards = container.querySelectorAll('.article-word-card');
            const zones = container.querySelectorAll('.article-drop-zone');
            const wordsContainer = container.querySelector('.words-to-sort');
            
            // Drag & Drop
            cards.forEach(card => {
                card.addEventListener('dragstart', function(e) {
                    e.dataTransfer.effectAllowed = 'move';
                    this.classList.add('dragging');
                });
                
                card.addEventListener('dragend', function() {
                    this.classList.remove('dragging');
                });
                
                // –ö–ª–∏–∫ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
                card.addEventListener('click', function() {
                    const wasSelected = this.classList.contains('selected');
                    cards.forEach(c => c.classList.remove('selected'));
                    if (!wasSelected) {
                        this.classList.add('selected');
                    }
                });
            });
            
            zones.forEach(zone => {
                zone.addEventListener('dragover', e => {
                    e.preventDefault();
                    zone.classList.add('drag-over');
                });
                
                zone.addEventListener('dragleave', () => {
                    zone.classList.remove('drag-over');
                });
                
                zone.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('drag-over');
                    const dragging = container.querySelector('.dragging');
                    if (dragging) {
                        this.appendChild(dragging);
                    }
                });
                
                // –ö–ª–∏–∫ –ø–æ –∑–æ–Ω–µ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
                zone.addEventListener('click', function() {
                    const selected = container.querySelector('.article-word-card.selected');
                    if (selected) {
                        this.appendChild(selected);
                        selected.classList.remove('selected');
                    }
                });
            });
            
            // –í–æ–∑–≤—Ä–∞—Ç –≤ –∏—Å—Ö–æ–¥–Ω—É—é –∑–æ–Ω—É
            if (wordsContainer) {
                wordsContainer.addEventListener('dragover', e => e.preventDefault());
                wordsContainer.addEventListener('drop', function(e) {
                    e.preventDefault();
                    const dragging = container.querySelector('.dragging');
                    if (dragging) this.appendChild(dragging);
                });
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞
            const checkBtn = container.querySelector('.check-articles-btn');
            if (checkBtn) {
                checkBtn.addEventListener('click', () => {
                    let correct = 0, total = 0;
                    
                    zones.forEach(zone => {
                        const targetArticle = zone.dataset.zone;
                        const cardsInZone = zone.querySelectorAll('.article-word-card');
                        
                        cardsInZone.forEach(card => {
                            total++;
                            card.classList.remove('correct', 'incorrect');
                            
                            if (card.dataset.article === targetArticle) {
                                card.classList.add('correct');
                                correct++;
                            } else {
                                card.classList.add('incorrect');
                            }
                        });
                    });
                    
                    const feedback = container.querySelector('.articles-feedback');
                    if (feedback) {
                        if (correct === total && total > 0) {
                            feedback.innerHTML = '‚úÖ –û—Ç–ª–∏—á–Ω–æ! –í—Å–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ!';
                            feedback.className = 'articles-feedback success';
                        } else {
                            feedback.innerHTML = `–ü—Ä–∞–≤–∏–ª—å–Ω–æ: ${correct} –∏–∑ ${total}`;
                            feedback.className = 'articles-feedback partial';
                        }
                    }
                });
            }
            
            // –°–±—Ä–æ—Å
            const resetBtn = container.querySelector('.reset-articles-btn');
            if (resetBtn) {
                resetBtn.addEventListener('click', () => {
                    cards.forEach(card => {
                        card.classList.remove('correct', 'incorrect', 'selected');
                        if (wordsContainer) {
                            wordsContainer.appendChild(card);
                        }
                    });
                    
                    const feedback = container.querySelector('.articles-feedback');
                    if (feedback) {
                        feedback.innerHTML = '';
                        feedback.className = 'articles-feedback';
                    }
                });
            }
        }

        // ========================================
        // –£–ü–†–ê–ñ–ù–ï–ù–ò–ï: –ö–û–ù–¢–ï–ö–°–¢–ù–´–ô –ü–ï–†–ï–í–û–î
        // ========================================
        function initializeContextTranslation(container, phaseData) {
            const exercises = [];
            
            if (phaseData.words) {
                phaseData.words.forEach(word => {
                    if (word.word && word.translation && word.sentence && word.sentenceTranslation) {
                        // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–≥—É–ª—è—Ä–Ω–æ–≥–æ –≤—ã—Ä–∞–∂–µ–Ω–∏—è
                        const germanWord = word.word.replace(/^(der|die|das)\s+/i, '');
                        const escapedWord = germanWord.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                        const wordPattern = new RegExp(`\\b${escapedWord}\\w*\\b`, 'gi');
                        
                        if (word.sentence.match(wordPattern)) {
                            exercises.push({
                                germanWord: word.word,
                                translation: word.translation,
                                sentence: word.sentence,
                                sentenceTranslation: word.sentenceTranslation,
                                germanBlank: word.sentence.replace(wordPattern, '_____')
                            });
                        }
                    }
                });
            }
            
            if (exercises.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">–í —ç—Ç–æ–π —Ñ–∞–∑–µ –Ω–µ—Ç —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –ø–µ—Ä–µ–≤–æ–¥–∞</p>';
                return;
            }
            
            // –ë–µ—Ä–µ–º –¥–æ 5 —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π
            const selected = exercises.slice(0, 5);
            
            container.innerHTML = `
                <div class="context-exercises">
                    ${selected.map((ex, idx) => {
                        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤
                        const options = generateOptions(ex.translation, phaseData);
                        
                        return `
                            <div class="context-exercise-card">
                                <div style="font-weight: bold; margin-bottom: 1rem;">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ ${idx + 1}</div>
                                
                                <div style="background: #f8f9fa; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                                    <div style="margin-bottom: 0.5rem;">${ex.germanBlank}</div>
                                    <div style="color: #666; font-style: italic;">${ex.sentenceTranslation}</div>
                                </div>
                                
                                <div style="margin-bottom: 1rem;">
                                    –ü—Ä–æ–ø—É—â–µ–Ω–Ω–æ–µ —Å–ª–æ–≤–æ: <strong>${ex.germanWord}</strong>
                                </div>
                                
                                <div class="context-options">
                                    ${options.map(opt => `
                                        <button class="context-option"
                                                data-correct="${opt === ex.translation}">
                                            ${opt}
                                        </button>
                                    `).join('')}
                                </div>
                                
                                <div class="context-feedback"></div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            attachContextHandlers(container);
        }

        // ========================================
        // –ì–ï–ù–ï–†–ê–¶–ò–Ø –í–ê–†–ò–ê–ù–¢–û–í –û–¢–í–ï–¢–û–í
        // ========================================
        function generateOptions(correct, phaseData) {
            const options = [correct];
            const allTranslations = new Set();
            
            // –°–æ–±–∏—Ä–∞–µ–º –ø–µ—Ä–µ–≤–æ–¥—ã –∏–∑ —Ç–µ–∫—É—â–µ–π —Ñ–∞–∑—ã
            if (phaseData.words) {
                phaseData.words.forEach(word => {
                    if (word.translation && word.translation !== correct) {
                        allTranslations.add(word.translation);
                    }
                });
            }
            
            // –ï—Å–ª–∏ –º–∞–ª–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤, –¥–æ–±–∞–≤–ª—è–µ–º –æ–±—â–∏–µ
            const fallback = ['–≤–ª–∞—Å—Ç—å', '—Ç—Ä–æ–Ω', '–∫–æ—Ä–æ–Ω–∞', '–∫–æ—Ä–æ–ª–µ–≤—Å—Ç–≤–æ', '–ø—Ä–µ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ', '–≤–µ—Ä–Ω–æ—Å—Ç—å'];
            fallback.forEach(word => {
                if (word !== correct) allTranslations.add(word);
            });
            
            // –í—ã–±–∏—Ä–∞–µ–º 3 –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–∞
            const wrong = Array.from(allTranslations)
                .sort(() => Math.random() - 0.5)
                .slice(0, 3);
            
            options.push(...wrong);
            
            // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º
            return options.sort(() => Math.random() - 0.5);
        }

        // ========================================
        // –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –î–õ–Ø –ö–û–ù–¢–ï–ö–°–¢–ù–û–ì–û –ü–ï–†–ï–í–û–î–ê
        // ========================================
        function attachContextHandlers(container) {
            const cards = container.querySelectorAll('.context-exercise-card');
            
            cards.forEach(card => {
                const options = card.querySelectorAll('.context-option');
                const feedback = card.querySelector('.context-feedback');
                
                options.forEach(option => {
                    option.addEventListener('click', function() {
                        // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –∫–ª–∏–∫–∏
                        if (card.classList.contains('answered')) return;
                        card.classList.add('answered');
                        
                        // –ë–ª–æ–∫–∏—Ä—É–µ–º –≤—Å–µ –∫–Ω–æ–ø–∫–∏
                        options.forEach(opt => opt.disabled = true);
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–≤–µ—Ç
                        if (this.dataset.correct === 'true') {
                            this.classList.add('correct');
                            feedback.innerHTML = '‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ!';
                            feedback.className = 'context-feedback success';
                        } else {
                            this.classList.add('incorrect');
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
                            options.forEach(opt => {
                                if (opt.dataset.correct === 'true') {
                                    opt.classList.add('correct');
                                }
                            });
                            feedback.innerHTML = '‚ùå –ù–µ–≤–µ—Ä–Ω–æ. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –≤—ã–¥–µ–ª–µ–Ω –∑–µ–ª–µ–Ω—ã–º.';
                            feedback.className = 'context-feedback error';
                        }
                    });
                });
            });
        }

        // ========================================
        // –ê–ö–ö–û–†–î–ï–û–ù –î–õ–Ø –£–ü–†–ê–ñ–ù–ï–ù–ò–ô
        // ========================================
        function initializeAccordion() {
            const toggles = document.querySelectorAll('.exercise-toggle');
            
            toggles.forEach(toggle => {
                toggle.addEventListener('click', function() {
                    const panel = this.closest('.exercise-panel');
                    const content = panel.querySelector('.exercise-content');
                    const icon = this.querySelector('.toggle-icon');
                    
                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ –ø–∞–Ω–µ–ª–∏
                    document.querySelectorAll('.exercise-panel').forEach(p => {
                        if (p !== panel) {
                            const c = p.querySelector('.exercise-content');
                            const i = p.querySelector('.toggle-icon');
                            c.classList.remove('expanded');
                            i.textContent = '‚ñ∂';
                        }
                    });
                    
                    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ç–µ–∫—É—â—É—é
                    const isExpanded = content.classList.contains('expanded');
                    content.classList.toggle('expanded');
                    icon.textContent = isExpanded ? '‚ñ∂' : '‚ñº';
                });
            });
        }

        // ========================================
        // –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–õ–ò–ö–û–í –ü–û TIMELINE
        // ========================================
        function initializeTimeline() {
            const points = document.querySelectorAll('.journey-point');
            
            points.forEach((point, index) => {
                point.addEventListener('click', () => {
                    changePhase(index);
                });
            });
        }

        // ========================================
        // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï
        // ========================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('[Journey] Initializing...');
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
            initializeAccordion();
            initializeTimeline();
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–≤–æ–π —Ñ–∞–∑—ã
            if (phaseKeys.length > 0) {
                changePhase(0);
            }
            
            console.log('[Journey] Ready!');
        });

    })();
    </script>
</body>
</html>

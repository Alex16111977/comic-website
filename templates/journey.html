<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ character.title }} | K√∂nig Lear</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../static/css/journey.css">
    <link rel="stylesheet" href="../static/css/exercises.css">
</head>
<body>
    <div class="container">
        <header class="page-header">
            <div class="header-nav">
                <a href="{{ navigation.home_href }}" class="home-link">
                    <span class="arrow">{{ navigation.home_icon }}</span>
                    <span class="text">{{ navigation.home_label }}</span>
                </a>
                <div class="study-counter" data-study-counter role="status" aria-live="polite">
                    <span class="study-counter-label">{{ navigation.study_label }}</span>
                    <span class="counter-badge" data-study-count>0</span>
                </div>
            </div>
            <h1>üëë {{ character.title }}</h1>
            <p class="subtitle">–ò–∑—É—á–∞–µ–º –Ω–µ–º–µ—Ü–∫–∏–π —á–µ—Ä–µ–∑ —Ç—Ä–∞–≥–µ–¥–∏—é –®–µ–∫—Å–ø–∏—Ä–∞</p>
        </header>

        <div class="journey-section">
            <h2>üìö –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ {{ character.name }}</h2>

            <div class="journey-timeline">
                <svg class="journey-line" width="100%" height="4">
                    <line x1="0" y1="2" x2="100%" y2="2" stroke="#6b5b95" stroke-width="2" opacity="0.3" />
                    <line x1="0" y1="2" x2="100%" y2="2" stroke="#6b5b95" stroke-width="3" class="progress-line" data-start-progress="{{ initial_progress }}" />
                </svg>

                <div class="journey-points">
                    {% for phase in journey_phases %}
                    <div class="journey-point{% if loop.first %} active{% endif %}" data-phase="{{ phase.id }}">
                        <div class="point-circle">{{ phase.icon }}</div>
                        <h4>{{ phase.title }}</h4>
                        {% if phase.keywords %}
                        <p>{{ phase.keywords }}</p>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="journey-progress">
                <div class="progress-track">
                    <div class="progress-fill" style="width: {{ initial_progress }}%"></div>
                </div>
                <div class="progress-text">{{ initial_description }}</div>
            </div>
        </div>

        {% if journey_phases %}
        <div class="theatrical-scenes">
            {% for phase in journey_phases if phase.theatrical_scene %}
            <div class="theatrical-scene{% if loop.first %} active{% endif %}" data-phase="{{ phase.id }}">
                <h3 class="scene-title">{{ phase.theatrical_scene.title }}</h3>
                <div class="scene-narrative">{{ phase.theatrical_scene.narrative | safe }}</div>
                <div class="emotional-peak">{{ phase.theatrical_scene.emotional_peak }}</div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <div class="vocabulary-section">
            <h2>üìñ –°–ª–æ–≤–∞—Ä—å: –§–∞–∑–∞ "<span id="current-phase">{{ first_phase_title }}</span>"</h2>
            <div class="vocabulary-grid"></div>

            <div class="phase-navigation">
                <button class="change-phase-btn prev-btn" type="button">‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∞—è —Ñ–∞–∑–∞</button>
                <button class="change-phase-btn next-btn" type="button">–°–ª–µ–¥—É—é—â–∞—è —Ñ–∞–∑–∞ ‚Üí</button>
            </div>
        </div>

        <div class="exercises-section">
            <h2>üìù –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</h2>

            <div class="exercises-accordion">
                <div class="exercise-panel" data-exercise="matching">
                    <button class="exercise-toggle" type="button">
                        <span class="toggle-icon">‚ñ∂</span>
                        üîó –ü–æ–¥–±–æ—Ä —Å–ª–æ–≤
                    </button>
                    <div class="exercise-content collapsed">
                        <p class="exercise-description">–°–æ–ø–æ—Å—Ç–∞–≤—å—Ç–µ –Ω–µ–º–µ—Ü–∫–∏–µ —Å–ª–æ–≤–∞ —Ç–µ–∫—É—â–µ–π —Ñ–∞–∑—ã —Å –∏—Ö –ø–µ—Ä–µ–≤–æ–¥–∞–º–∏ –∏ –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏.</p>
                        <div class="exercise-phase-wrapper" data-phase-wrapper="matching">
                            {% for phase in journey_phases %}
                            <section class="exercise-phase{% if loop.first %} active{% endif %}" data-phase="{{ phase.id }}">
                                <div class="matching-container" data-matching-container data-phase="{{ phase.id }}"></div>
                            </section>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div class="exercise-panel" data-exercise="articles">
                    <button class="exercise-toggle" type="button">
                        <span class="toggle-icon">‚ñ∂</span>
                        üéØ –ê—Ä—Ç–∏–∫–ª–∏ –∏ —Ä–æ–¥
                    </button>
                    <div class="exercise-content collapsed">
                        <p class="exercise-description">–†–∞–∑–ª–æ–∂–∏—Ç–µ —Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ —Ä–æ–¥–∞–º –∏ –∑–∞–ø–æ–º–Ω–∏—Ç–µ –∏—Ö –≤–º–µ—Å—Ç–µ —Å –ø–µ—Ä–µ–≤–æ–¥–æ–º.</p>
                        <div class="exercise-phase-wrapper" data-phase-wrapper="articles">
                            {% for phase in journey_phases %}
                            <section class="exercise-phase{% if loop.first %} active{% endif %}" data-phase="{{ phase.id }}">
                                <div class="articles-container" data-articles-container data-phase="{{ phase.id }}"></div>
                            </section>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div class="exercise-panel" data-exercise="context">
                    <button class="exercise-toggle" type="button">
                        <span class="toggle-icon">‚ñ∂</span>
                        üìù –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥
                    </button>
                    <div class="exercise-content collapsed">
                        <p class="exercise-description">–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–µ–≤–æ–¥ –ø—Ä–æ–ø—É—â–µ–Ω–Ω–æ–≥–æ —Å–ª–æ–≤–∞ –≤ —Ü–∏—Ç–∞—Ç–∞—Ö –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞.</p>
                        <div class="exercise-phase-wrapper" data-phase-wrapper="context">
                            {% for phase in journey_phases %}
                            <section class="exercise-phase{% if loop.first %} active{% endif %}" data-phase="{{ phase.id }}">
                                <div class="context-container" data-context-container data-phase="{{ phase.id }}"></div>
                            </section>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div class="exercise-panel" data-exercise="quiz">
                    <button class="exercise-toggle" type="button">
                        <span class="toggle-icon">‚ñ∂</span>
                        üß† –í–∏–∫—Ç–æ—Ä–∏–Ω–∞ –ø–æ —Å–ª–æ–≤–∞–º
                    </button>
                    <div class="exercise-content collapsed">
                        <div class="quiz-header">
                            <div class="quiz-progress">
                                <span class="progress-text">–í–æ–ø—Ä–æ—Å <span id="current-question">1</span> –∏–∑ <span id="total-questions">1</span></span>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="quiz-mode-indicator">
                                <span class="mode-badge active" data-mode="forward">DE ‚Üí RU</span>
                                <span class="mode-badge" data-mode="reverse">RU ‚Üí DE</span>
                            </div>
                        </div>

                        <div class="quiz-content">
                            <div class="quiz-placeholder">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–∑—É, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –≤–∏–∫—Ç–æ—Ä–∏–Ω—É.</div>
                        </div>
                    </div>
                </div>

                <div class="exercise-panel" data-exercise="constructor">
                    <button class="exercise-toggle" type="button">
                        <span class="toggle-icon">‚ñ∂</span>
                        üß© –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
                    </button>
                    <div class="exercise-content collapsed">
                        <div class="constructor-section">
                            <p class="constructor-intro">–°–æ–±–µ—Ä–∏—Ç–µ –Ω–µ–º–µ—Ü–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∏–∑ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤ –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ–±—è –ø–æ –ø–µ—Ä–µ–≤–æ–¥—É.</p>

                            {% for phase in journey_phases %}
                            <section class="constructor-panel{% if loop.first %} active{% endif %}" data-phase="{{ phase.id }}">
                                <div class="constructor-header">
                                    <div class="constructor-word" data-constructor-word>‚Äî</div>
                                    <div class="constructor-translation" data-constructor-translation></div>
                                    <div class="constructor-progress" data-constructor-progress></div>
                                </div>
                                <p class="constructor-hint" data-constructor-hint>–í—ã–±–µ—Ä–∏—Ç–µ —Å–ª–µ–¥—É—é—â—É—é —Ñ—Ä–∞–∑—É, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É.</p>

                                <div class="constructor-areas">
                                    <div class="constructor-source" data-constructor-source></div>
                                    <div class="constructor-target" data-constructor-target>
                                        <div class="constructor-placeholder">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã, —á—Ç–æ–±—ã —Å–æ–±—Ä–∞—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ.</div>
                                    </div>
                                </div>

                                <div class="constructor-controls">
                                    <button class="constructor-control constructor-check" type="button">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
                                    <button class="constructor-control constructor-reset" type="button">–°–±—Ä–æ—Å–∏—Ç—å</button>
                                    <button class="constructor-control constructor-next" type="button">–°–ª–µ–¥—É—é—â–µ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ</button>
                                </div>

                                <div class="constructor-feedback" aria-live="polite"></div>
                                <div class="constructor-original" data-constructor-original></div>

                                {% if not phase.sentence_parts %}
                                <p class="constructor-empty">–î–ª—è —ç—Ç–æ–π —Ñ–∞–∑—ã –ø–æ–∫–∞ –Ω–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –¥–ª—è –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞, –æ–Ω–∏ –ø–æ—è–≤—è—Ç—Å—è –ø–æ–∑–∂–µ.</p>
                                {% endif %}
                            </section>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="exercises-container">
            {% for exercise in exercises %}
            <div class="exercise-container{% if exercise.is_active %} active{% endif %}" data-phase="{{ exercise.phase_id }}">
                <div class="exercise-section">
                    <h4 class="exercise-title">üìù –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ: {{ exercise.title }}</h4>
                    <div class="exercise-text">{{ exercise.text | safe }}</div>
                    <button class="show-answer-btn" onclick="toggleAnswers(this)" type="button" aria-label="–ü–æ–∫–∞–∑–∞—Ç—å –∏–ª–∏ —Å–∫—Ä—ã—Ç—å –æ—Ç–≤–µ—Ç—ã">–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç—ã</button>
                </div>
            </div>
            {% endfor %}
        </div>

        <nav class="bottom-nav">
            <a href="../index.html" class="nav-link">‚Üê –ö –≥–ª–∞–≤–Ω–æ–π</a>
        </nav>
    </div>

    <script>{{ journey_data | safe }}</script>
    <script>
    // Runtime JavaScript –±–µ–∑ –º–æ–¥—É–ª–µ–π
    (function() {
        let currentPhaseIndex = 0;
        const phaseKeys = Object.keys(phaseVocabularies);
        let isTransitioning = false;

        function displayVocabulary(phaseKey) {
            if (isTransitioning) return;
            isTransitioning = true;

            const phase = phaseVocabularies[phaseKey];
            const grid = document.querySelector('.vocabulary-grid');
            const phaseTitle = document.getElementById('current-phase');
            const progressFill = document.querySelector('.journey-progress .progress-fill');
            const progressText = document.querySelector('.journey-progress .progress-text');
            
            if (!phase || !grid || !phaseTitle) {
                console.error('Missing required elements');
                isTransitioning = false;
                return;
            }

            phaseTitle.textContent = phase.title;

            // Update theatrical scene
            const scenes = document.querySelectorAll('.theatrical-scene');
            scenes.forEach(scene => {
                if (scene.dataset.phase === phaseKey) {
                    scene.classList.add('active');
                } else {
                    scene.classList.remove('active');
                }
            });

            // Update exercises
            const exercises = document.querySelectorAll('.exercise-container');
            exercises.forEach(exercise => {
                if (exercise.dataset.phase === phaseKey) {
                    exercise.classList.add('active');
                } else {
                    exercise.classList.remove('active');
                }
            });
            
            // Initialize exercises for current phase
            if (window.initializeExercises) {
                window.initializeExercises(phaseKey);
            }

            // Clear and populate vocabulary grid
            grid.innerHTML = '';

            phase.words.forEach((item, index) => {
                setTimeout(() => {
                    const card = document.createElement('div');
                    card.className = 'word-card';
                    card.style.animationDelay = `${index * 0.1}s`;

                    const hintMarkup = item.russian_hint
                        ? `<div class="word-hint">(${item.russian_hint})</div>`
                        : '';

                    card.innerHTML = `
                        <div class="word-meta">
                            <div class="word-german">${item.word}</div>
                            <div class="word-translation">${item.translation}</div>
                            ${hintMarkup}
                            <div class="word-transcription">${item.transcription}</div>
                        </div>
                        <button class="btn-study" type="button">–ò–∑—É—á–∏—Ç—å</button>
                    `;

                    grid.appendChild(card);
                }, index * 50);
            });

            // Update progress bar
            const progress = ((currentPhaseIndex + 1) / phaseKeys.length) * 100;
            if (progressFill) progressFill.style.width = progress + '%';
            if (progressText) progressText.textContent = phase.description;

            // Update navigation buttons
            updateNavigationButtons();

            setTimeout(() => {
                isTransitioning = false;
            }, 500);
        }

        function updateNavigationButtons() {
            const prevBtn = document.querySelector('.prev-btn');
            const nextBtn = document.querySelector('.next-btn');
            
            if (prevBtn) {
                prevBtn.disabled = currentPhaseIndex === 0;
                prevBtn.style.opacity = currentPhaseIndex === 0 ? '0.5' : '1';
                prevBtn.style.cursor = currentPhaseIndex === 0 ? 'not-allowed' : 'pointer';
            }
            
            if (nextBtn) {
                nextBtn.disabled = currentPhaseIndex >= phaseKeys.length - 1;
                nextBtn.style.opacity = currentPhaseIndex >= phaseKeys.length - 1 ? '0.5' : '1';
                nextBtn.style.cursor = currentPhaseIndex >= phaseKeys.length - 1 ? 'not-allowed' : 'pointer';
            }
        }

        function handleJourneyPointClick(point, index) {
            if (isTransitioning) return;
            
            const journeyPoints = document.querySelectorAll('.journey-point');
            journeyPoints.forEach(p => p.classList.remove('active'));
            point.classList.add('active');
            currentPhaseIndex = index;
            displayVocabulary(point.dataset.phase);
        }

        // Initialize on DOM ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('[Init] Starting initialization...');

            const journeyPoints = document.querySelectorAll('.journey-point');
            console.log('[Init] Found', journeyPoints.length, 'journey points');
            
            // Setup journey point clicks
            journeyPoints.forEach((point, index) => {
                point.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    handleJourneyPointClick(this, index);
                });
                
                point.style.cursor = 'pointer';
            });
            
            // Previous button handler
            const prevBtn = document.querySelector('.prev-btn');
            if (prevBtn) {
                prevBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    if (!isTransitioning && currentPhaseIndex > 0) {
                        currentPhaseIndex--;
                        const targetPoint = journeyPoints[currentPhaseIndex];
                        if (targetPoint) {
                            handleJourneyPointClick(targetPoint, currentPhaseIndex);
                        }
                    }
                });
            }
            
            // Next button handler
            const nextBtn = document.querySelector('.next-btn');
            if (nextBtn) {
                nextBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    if (!isTransitioning && currentPhaseIndex < phaseKeys.length - 1) {
                        currentPhaseIndex++;
                        const targetPoint = journeyPoints[currentPhaseIndex];
                        if (targetPoint) {
                            handleJourneyPointClick(targetPoint, currentPhaseIndex);
                        }
                    }
                });
            }
            
            // Initialize first phase
            if (journeyPoints.length > 0 && phaseKeys.length > 0) {
                console.log('[Init] Initializing first phase:', phaseKeys[0]);
                journeyPoints[0].classList.add('active');
                displayVocabulary(phaseKeys[0]);
            } else {
                console.error('[Init] No journey points or phases found!');
            }
            
            console.log('[Init] Initialization complete');
        });

        // Exercise toggle handlers
        window.toggleAnswers = function(button) {
            const exerciseSection = button.closest('.exercise-section');
            if (!exerciseSection) return;
            
            const exerciseText = exerciseSection.querySelector('.exercise-text');
            const blanks = exerciseText.querySelectorAll('.blank');
            
            if (button.textContent === '–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç—ã') {
                blanks.forEach(blank => {
                    const answer = blank.getAttribute('data-answer');
                    const hint = blank.getAttribute('data-hint');
                    if (answer && hint) {
                        blank.innerHTML = answer + ' (' + hint + ')';
                        blank.style.color = '#d97706';
                        blank.style.fontWeight = '600';
                        blank.style.fontStyle = 'normal';
                        blank.style.borderBottomColor = '#22c55e';
                    }
                });
                button.textContent = '–°–∫—Ä—ã—Ç—å –æ—Ç–≤–µ—Ç—ã';
                button.style.background = 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)';
            } else {
                blanks.forEach(blank => {
                    const hint = blank.getAttribute('data-hint');
                    if (hint) {
                        blank.innerHTML = '_______ (' + hint + ')';
                        blank.style.color = '#a0aec0';
                        blank.style.fontWeight = 'normal';
                        blank.style.fontStyle = 'italic';
                        blank.style.borderBottomColor = '#f6ad55';
                    }
                });
                button.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç—ã';
                button.style.background = 'linear-gradient(135deg, #f6ad55 0%, #ed8936 100%)';
            }
        }

        console.log('[Runtime] JavaScript loaded successfully');
    })();
    </script>
    <script>
    // –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –±–µ–∑ –º–æ–¥—É–ª–µ–π
    (function() {
        'use strict';

        // –ì–õ–û–ë–ê–õ–¨–ù–ê–Ø –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
        window.initializeExercises = function(phaseId) {
            console.log('[Exercises] Initializing for phase:', phaseId);

            if (!phaseId) {
                return;
            }

            const phaseVocabulary = window.phaseVocabularies && window.phaseVocabularies[phaseId];
            if (!phaseVocabulary) {
                console.warn('[Exercises] No data for phase:', phaseId);
                return;
            }

            const articlesContainer = document.querySelector(`[data-articles-container][data-phase="${phaseId}"]`);
            if (articlesContainer) {
                initializeArticlesExercise(articlesContainer, phaseVocabulary);
            }

            const contextContainer = document.querySelector(`[data-context-container][data-phase="${phaseId}"]`);
            if (contextContainer) {
                initializeContextTranslation(contextContainer, phaseVocabulary);
            }
        };

        // –£–ü–†–ê–ñ–ù–ï–ù–ò–ï "–ê–†–¢–ò–ö–õ–ò –ò –†–û–î"
        function initializeArticlesExercise(container, phaseVocabulary) {
            if (!(container instanceof HTMLElement)) {
                return;
            }

            // –ò–∑–≤–ª–µ–∫–∞–µ–º —Å–ª–æ–≤–∞ —Å –∞—Ä—Ç–∏–∫–ª—è–º–∏
            const wordsWithArticles = [];
            if (phaseVocabulary && phaseVocabulary.words) {
                phaseVocabulary.words.forEach(word => {
                    if (!word.word || !word.translation) return;
                    
                    const parts = word.word.split(' ');
                    if (['der', 'die', 'das'].includes(parts[0])) {
                        wordsWithArticles.push({
                            article: parts[0],
                            german: parts.slice(1).join(' '),
                            russian: word.translation,
                            fullWord: word.word
                        });
                    }
                });
            }
            
            // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º –∏ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–æ 9 —Å–ª–æ–≤
            const shuffled = wordsWithArticles.sort(() => Math.random() - 0.5).slice(0, 9);

            if (shuffled.length === 0) {
                container.innerHTML = '<div class="exercise-empty-state">–í —ç—Ç–æ–π —Ñ–∞–∑–µ –Ω–µ—Ç —Å–ª–æ–≤ —Å –∞—Ä—Ç–∏–∫–ª—è–º–∏.</div>';
                return;
            }

            container.innerHTML = `
                <div class="articles-exercise">
                    <div class="articles-instruction">
                        –†–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç–µ —Å–ª–æ–≤–∞ –ø–æ —Ä–æ–¥–∞–º (drag & drop –∏–ª–∏ –∫–ª–∏–∫ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö)
                    </div>

                    <div class="article-columns">
                        <div class="article-column" data-article="der">
                            <h5 class="article-header">
                                <span class="article-label">DER</span>
                                <span class="article-desc">–º—É–∂—Å–∫–æ–π —Ä–æ–¥</span>
                            </h5>
                            <div class="article-drop-zone" data-zone="der"></div>
                        </div>
                        <div class="article-column" data-article="die">
                            <h5 class="article-header">
                                <span class="article-label">DIE</span>
                                <span class="article-desc">–∂–µ–Ω—Å–∫–∏–π —Ä–æ–¥</span>
                            </h5>
                            <div class="article-drop-zone" data-zone="die"></div>
                        </div>
                        <div class="article-column" data-article="das">
                            <h5 class="article-header">
                                <span class="article-label">DAS</span>
                                <span class="article-desc">—Å—Ä–µ–¥–Ω–∏–π —Ä–æ–¥</span>
                            </h5>
                            <div class="article-drop-zone" data-zone="das"></div>
                        </div>
                    </div>

                    <div class="words-to-sort">
                        ${shuffled.map((word, idx) => `
                            <div class="article-word-card"
                                 data-article="${word.article}"
                                 data-word="${word.german}"
                                 data-index="${idx}"
                                 draggable="true">
                                <span class="word-german">${word.german}</span>
                                <span class="word-russian">${word.russian}</span>
                            </div>
                        `).join('')}
                    </div>

                    <div class="articles-controls">
                        <button class="check-articles-btn" type="button">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
                        <button class="reset-articles-btn" type="button">–°–±—Ä–æ—Å–∏—Ç—å</button>
                    </div>
                    <div class="articles-feedback"></div>
                </div>
            `;

            const exerciseElement = container.querySelector('.articles-exercise');
            if (exerciseElement) {
                attachArticlesDragDrop(exerciseElement);
            }
        }
        
        function attachArticlesDragDrop(container) {
            const cards = container.querySelectorAll('.article-word-card');
            const zones = container.querySelectorAll('.article-drop-zone');
            const checkBtn = container.querySelector('.check-articles-btn');
            const resetBtn = container.querySelector('.reset-articles-btn');
            const feedback = container.querySelector('.articles-feedback');
            const wordsContainer = container.querySelector('.words-to-sort');
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –¥–ª—è —Å–±—Ä–æ—Å–∞
            const initialParent = cards[0]?.parentElement;
            
            // DRAG & DROP –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞
            cards.forEach(card => {
                card.addEventListener('dragstart', (e) => {
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', '');
                    card.classList.add('dragging');
                    card.dataset.dragArticle = card.dataset.article;
                    card.dataset.dragWord = card.dataset.word;
                });

                card.addEventListener('dragend', () => {
                    card.classList.remove('dragging');
                });
                
                // –ö–õ–ò–ö –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
                card.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const wasSelected = this.classList.contains('selected');
                    
                    // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
                    cards.forEach(c => c.classList.remove('selected'));
                    
                    if (!wasSelected) {
                        this.classList.add('selected');
                    }
                });
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∑–æ–Ω
            zones.forEach(zone => {
                zone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    zone.classList.add('drag-over');
                });
                
                zone.addEventListener('dragleave', () => {
                    zone.classList.remove('drag-over');
                });
                
                zone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    zone.classList.remove('drag-over');

                    const draggingCard = container.querySelector('.dragging');
                    if (draggingCard) {
                        zone.appendChild(draggingCard);
                        draggingCard.classList.remove('correct', 'incorrect');
                    }
                });

                // –ö–ª–∏–∫ –ø–æ –∑–æ–Ω–µ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
                zone.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const selected = container.querySelector('.article-word-card.selected');
                    if (selected) {
                        this.appendChild(selected);
                        selected.classList.remove('selected', 'correct', 'incorrect');
                    }
                });
            });

            if (wordsContainer) {
                wordsContainer.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                });

                wordsContainer.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const draggingCard = container.querySelector('.dragging');
                    if (draggingCard) {
                        wordsContainer.appendChild(draggingCard);
                        draggingCard.classList.remove('correct', 'incorrect');
                    }
                });

                wordsContainer.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const selected = container.querySelector('.article-word-card.selected');
                    if (selected && selected.parentElement !== wordsContainer) {
                        wordsContainer.appendChild(selected);
                        selected.classList.remove('selected', 'correct', 'incorrect');
                    }
                });
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤
            checkBtn?.addEventListener('click', () => {
                let correct = 0;
                let total = 0;
                
                zones.forEach(zone => {
                    const targetArticle = zone.dataset.zone;
                    const cardsInZone = zone.querySelectorAll('.article-word-card');
                    
                    cardsInZone.forEach(card => {
                        total++;
                        card.classList.remove('correct', 'incorrect');
                        
                        if (card.dataset.article === targetArticle) {
                            card.classList.add('correct');
                            correct++;
                        } else {
                            card.classList.add('incorrect');
                        }
                    });
                });
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏, –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –≤ –∏—Å—Ö–æ–¥–Ω–æ–π –∑–æ–Ω–µ
                const unsortedCards = wordsContainer.querySelectorAll('.article-word-card');
                unsortedCards.forEach(card => {
                    total++;
                    card.classList.add('incorrect');
                });
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                if (feedback) {
                    if (correct === total && total > 0) {
                        feedback.innerHTML = '<span class="success">[OK] –û—Ç–ª–∏—á–Ω–æ! –í—Å–µ –∞—Ä—Ç–∏–∫–ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ!</span>';
                        feedback.className = 'articles-feedback success';
                    } else {
                        feedback.innerHTML = `<span class="partial">–ü—Ä–∞–≤–∏–ª—å–Ω–æ: ${correct} –∏–∑ ${total}. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑!</span>`;
                        feedback.className = 'articles-feedback partial';
                    }
                }
            });

            // –°–±—Ä–æ—Å
            resetBtn?.addEventListener('click', () => {
                cards.forEach(card => {
                    card.classList.remove('correct', 'incorrect', 'selected');
                    if (initialParent) {
                        initialParent.appendChild(card);
                    }
                });

                if (feedback) {
                    feedback.innerHTML = '';
                    feedback.className = 'articles-feedback';
                }
            });
        }

        // –£–ü–†–ê–ñ–ù–ï–ù–ò–ï "–ö–û–ù–¢–ï–ö–°–¢–ù–´–ô –ü–ï–†–ï–í–û–î"
        function initializeContextTranslation(container, phaseVocabulary) {
            if (!(container instanceof HTMLElement)) {
                return;
            }

            // –°–æ–±–∏—Ä–∞–µ–º —Å–ª–æ–≤–∞ —Å –ø–æ–ª–Ω—ã–º–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º–∏
            const contextExercises = [];

            if (phaseVocabulary && phaseVocabulary.words) {
                phaseVocabulary.words.forEach((word, idx) => {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –≤—Å–µ—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–æ–ª–µ–π
                    if (!word.word || !word.translation || !word.sentence || !word.sentenceTranslation) {
                        return;
                    }
                    
                    // –£–±–∏—Ä–∞–µ–º –∞—Ä—Ç–∏–∫–ª—å –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–∏
                    const germanWord = word.word.replace(/^(der|die|das)\s+/i, '');
                    
                    // –°–æ–∑–¥–∞–µ–º —Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å–ª–æ–≤–∞ —Å —É—á–µ—Ç–æ–º –æ–∫–æ–Ω—á–∞–Ω–∏–π
                    const wordPattern = new RegExp(
                        `\\b${germanWord.replace(/[.*+?^${}()|[\\]\\]/g, '\\        console.log('[Runtime] JavaScript loaded successfully');
    })();
    </script>')}\\w*\\b`,
                        'gi'
                    );
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–ª–æ–≤–æ –≤ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–∏
                    if (word.sentence.match(wordPattern)) {
                        contextExercises.push({
                            id: `context-${idx}`,
                            germanWord: word.word,
                            russianWord: word.translation,
                            germanSentence: word.sentence,
                            russianSentence: word.sentenceTranslation,
                            // –°–æ–∑–¥–∞–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å –ø—Ä–æ–ø—É—Å–∫–æ–º
                            germanBlank: word.sentence.replace(wordPattern, '_____'),
                            russianBlank: word.sentenceTranslation.includes(word.translation) 
                                ? word.sentenceTranslation.replace(word.translation, '_____')
                                : word.sentenceTranslation,
                            correctAnswer: word.translation
                        });
                    }
                });
            }
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–æ 5 —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –∏ –ø–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º
            const exercises = contextExercises
                .sort(() => Math.random() - 0.5)
                .slice(0, 5);
            
            if (exercises.length === 0) {
                container.innerHTML = '<div class="exercise-empty-state">–í —ç—Ç–æ–π —Ñ–∞–∑–µ –Ω–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –ø–µ—Ä–µ–≤–æ–¥–∞.</div>';
                return;
            }

            container.innerHTML = `
                <div class="context-exercises">
                    <div class="context-instruction">
                        –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥ –ø—Ä–æ–ø—É—â–µ–Ω–Ω–æ–≥–æ —Å–ª–æ–≤–∞ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
                    </div>
                    ${exercises.map((ex, idx) => {
                        const options = generateOptions(ex.correctAnswer, phaseVocabulary);

                        return `
                            <div class="context-exercise-card" data-exercise-id="${ex.id}">
                                <div class="exercise-number">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ ${idx + 1}</div>

                                <div class="context-sentences">
                                    <div class="sentence-german">${ex.germanBlank}</div>
                                    <div class="sentence-russian">${ex.russianBlank}</div>
                                </div>

                                <div class="context-question">
                                    –ü—Ä–æ–ø—É—â–µ–Ω–Ω–æ–µ —Å–ª–æ–≤–æ: <strong>${ex.germanWord}</strong>
                                </div>

                                <div class="context-options">
                                    ${options.map((opt, optIdx) => `
                                        <button class="context-option"
                                                type="button"
                                                data-answer="${opt}"
                                                data-correct="${opt === ex.correctAnswer}">
                                            ${String.fromCharCode(65 + optIdx)}) ${opt}
                                        </button>
                                    `).join('')}
                                </div>

                                <div class="context-feedback"></div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;

            attachContextHandlers(container);
        }
        
        function generateOptions(correctAnswer, phaseVocabulary) {
            const options = [correctAnswer];
            const allTranslations = [];
            
            // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –ø–µ—Ä–µ–≤–æ–¥—ã –∏–∑ —Ç–µ–∫—É—â–µ–π —Ñ–∞–∑—ã
            if (phaseVocabulary && phaseVocabulary.words) {
                phaseVocabulary.words.forEach(word => {
                    if (word.translation && word.translation !== correctAnswer) {
                        allTranslations.push(word.translation);
                    }
                });
            }
            
            // –ï—Å–ª–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –∏–∑ —Ç–µ–∫—É—â–µ–π —Ñ–∞–∑—ã, –¥–æ–±–∞–≤–ª—è–µ–º –æ–±—â–∏–µ
            if (allTranslations.length < 3) {
                const fallbackOptions = [
                    '–≤–ª–∞—Å—Ç—å', '—Ç—Ä–æ–Ω', '–∫–æ—Ä–æ–Ω–∞', '–∫–æ—Ä–æ–ª–µ–≤—Å—Ç–≤–æ', 
                    '–ø—Ä–µ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ', '–≤–µ—Ä–Ω–æ—Å—Ç—å', '–≥–æ—Ä–¥–æ—Å—Ç—å', '–¥–æ—á—å',
                    '—Å—É–¥—å–±–∞', '–º—É–¥—Ä–æ—Å—Ç—å', '–±–µ–∑—É–º–∏–µ', '–ø—Ä–∞–≤–¥–∞'
                ].filter(opt => opt !== correctAnswer);
                
                allTranslations.push(...fallbackOptions);
            }
            
            // –í—ã–±–∏—Ä–∞–µ–º 3 —Å–ª—É—á–∞–π–Ω—ã—Ö –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–∞
            const wrongOptions = allTranslations
                .sort(() => Math.random() - 0.5)
                .slice(0, 3);
            
            options.push(...wrongOptions);
            
            // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã
            return options.sort(() => Math.random() - 0.5);
        }
        
        function attachContextHandlers(container) {
            const cards = container.querySelectorAll('.context-exercise-card');
            
            cards.forEach(card => {
                const options = card.querySelectorAll('.context-option');
                const feedback = card.querySelector('.context-feedback');
                
                options.forEach(option => {
                    option.addEventListener('click', function(e) {
                        e.stopPropagation();
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª –ª–∏ —É–∂–µ –¥–∞–Ω –æ—Ç–≤–µ—Ç
                        if (card.classList.contains('answered')) {
                            return;
                        }
                        
                        // –ë–ª–æ–∫–∏—Ä—É–µ–º –≤—Å–µ –∫–Ω–æ–ø–∫–∏
                        options.forEach(opt => {
                            opt.disabled = true;
                            opt.classList.remove('selected');
                        });
                        
                        // –û—Ç–º–µ—á–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –∫–∞–∫ –æ—Ç–≤–µ—á–µ–Ω–Ω—É—é
                        card.classList.add('answered');
                        this.classList.add('selected');
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–≤–µ—Ç
                        if (this.dataset.correct === 'true') {
                            this.classList.add('correct');
                            feedback.innerHTML = '<span class="success">[OK] –ü—Ä–∞–≤–∏–ª—å–Ω–æ!</span>';
                            feedback.className = 'context-feedback success';
                            
                            // –ê–Ω–∏–º–∞—Ü–∏—è —É—Å–ø–µ—Ö–∞
                            card.classList.add('success-animation');
                        } else {
                            this.classList.add('incorrect');
                            
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
                            options.forEach(opt => {
                                if (opt.dataset.correct === 'true') {
                                    opt.classList.add('correct');
                                }
                            });
                            
                            feedback.innerHTML = '<span class="error">[X] –ù–µ–≤–µ—Ä–Ω–æ. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –≤—ã–¥–µ–ª–µ–Ω –∑–µ–ª–µ–Ω—ã–º.</span>';
                            feedback.className = 'context-feedback error';
                        }
                    });
                });
            });
        }
        
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–¥–æ–±–∞–≤–∏–º –µ—Å–ª–∏ –Ω—É–∂–Ω—ã)
        window.refreshActiveExerciseContentHeight = window.refreshActiveExerciseContentHeight || function() {};
        window.updateWordColumnScrollIndicators = window.updateWordColumnScrollIndicators || function() {};
        
        // –û–ë–ù–û–í–õ–ï–ù–ò–ï –ù–ê–ó–í–ê–ù–ò–ô –í UI –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ñ–∞–∑—ã
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                if (window.phaseKeys && window.phaseKeys.length > 0) {
                    window.initializeExercises(window.phaseKeys[0]);
                }
            }, 120);
        });

    })();
    </script>
    <script src="../static/js/exercises.js"></script>
</body>
</html>
